<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <link th:href="@{/css/weather.css}" rel="stylesheet" />
    <meta charset="UTF-8">
    <title>Weather Report</title>
</head>
<body>
<div>
    <input type="hidden" id="gridX" th:value="${weather.gridX}">
    <input type="hidden" id="gridY" th:value="${weather.gridY}">

</div>


<div class="weather-card" id="weather-data">
    <h2 id="current-time">--:--</h2>
    <!--    <p id="current-time">Time: &#45;&#45;:&#45;&#45;</p>-->
    <h1 id="temperature">--Â°C</h1>
    <span id="weather-icon" class="weather-icon">â˜€ï¸</span>
</div>

<p id="coordinates-display"></p>

</body>

<script>
    function getNextForecastTime() {
        let now = new Date();
        let nextForecastHour = Math.floor(now.getHours() / 3) * 3 - 1;
        if(nextForecastHour.toString().padStart(2, '0') === '00' || nextForecastHour.toString().padStart(2, '0') === '01' || nextForecastHour.toString().padStart(2, '0') === '02') {
            return '2300';
        }
        if(Math.floor(now.getHours())% 3 === 2 && now.getMinutes() >= 11) {
            return Math.floor(now.getHours()).toString().padStart(2, '0') + '00';
        }
        console.log(nextForecastHour.toString().padStart(2, '0') + '10');
        return nextForecastHour.toString().padStart(2, '0') + '00'; // ì˜ˆ: '0210', '0510'
    }

    function getWeather(gridX, gridY) {
        console.log("Fetching weather for coordinates:", gridX, gridY); // Debugging log
        var forecastTime = getNextForecastTime(); // ë‹¤ìŒ ì˜ˆë³´ ì‹œê°„ ê³„ì‚°
        var currentDate = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        console.log(forecastTime);
        console.log(currentDate);
        var xhr = new XMLHttpRequest();
        var url = 'https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst';
        var queryParams = '?' + encodeURIComponent('serviceKey') + '=' + 'hogAXADhx1TwUFYu9kBfwwvsv5m%2FwsLzvQT2tBT0BFSH3eLnXp88Dx%2FR6x2GCPtWKfaUQEPix2VcWYEp0Hz5Tw%3D%3D';
        queryParams += '&' + encodeURIComponent('pageNo') + '=' + encodeURIComponent('1');
        queryParams += '&' + encodeURIComponent('numOfRows') + '=' + encodeURIComponent('37'); //12ê°œì”© ì ìš© 12*4 = 48
        queryParams += '&' + encodeURIComponent('dataType') + '=' + encodeURIComponent('XML');
        queryParams += '&' + encodeURIComponent('base_date') + '=' + encodeURIComponent(currentDate);
        queryParams += '&' + encodeURIComponent('base_time') + '=' + encodeURIComponent(forecastTime);


        queryParams += '&' + encodeURIComponent('nx') + '=' + encodeURIComponent(gridX);
        queryParams += '&' + encodeURIComponent('ny') + '=' + encodeURIComponent(gridY);
        xhr.open('GET', url + queryParams);
        xhr.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200) {
                // ë‚ ì”¨ ë°ì´í„° ì²˜ë¦¬
                displayWeatherData(this.responseXML);
                // console.log(this.responseText);
                document.getElementById('weather-data').style.display = 'block';
            }
        };
        xhr.send();
    }

    function calculateCurrentTime() {
        let now = new Date();
        let currentTime = Math.floor(now.getHours()) * 100 - getNextForecastTime() - 100;
        return currentTime / 100;
    }
    function displayWeatherData(xml) {
        const items = xml.getElementsByTagName("item");
        let weatherData = {};

        updateCurrentTime(); // í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸ë¥¼ ì²˜ìŒì— í•œ ë²ˆ í˜¸ì¶œ
        setInterval(updateCurrentTime, 60000); // 1ë¶„ë§ˆë‹¤ ì‹œê°„ ì—…ë°ì´íŠ¸

        for (let i = 0; i < items.length; i++) {
            const time = items[i].getElementsByTagName("fcstTime")[0].childNodes[0].nodeValue;
            if (time.slice(0, 2) === new Date().getHours().toString().padStart(2, '0')) {
                const category = items[i].getElementsByTagName("category")[0].childNodes[0].nodeValue;
                const value = items[i].getElementsByTagName("fcstValue")[0].childNodes[0].nodeValue;
                weatherData[category] = value;
            }
        }

        document.getElementById('temperature').textContent = `${weatherData['TMP'] || '--'}Â°C`;
        document.getElementById('weather-icon').textContent = getWeatherIcon(parseInt(weatherData['SKY']), parseInt(weatherData['PTY']));
    }

    document.addEventListener("DOMContentLoaded", function() {
        var gridX = document.getElementById('gridX').value;
        var gridY = document.getElementById('gridY').value;
        if (gridX && gridY) {
            getWeather(gridX, gridY);
        }
    });

    function updateCurrentTime() {
        let now = new Date();
        let day = now.getDate().toString().padStart(2, '0');
        let month = (now.getMonth() + 1).toString().padStart(2, '0');
        let weekday = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][now.getDay()];
        let hours = now.getHours();
        let minutes = now.getMinutes().toString().padStart(2, '0');
        let seconds = now.getSeconds().toString().padStart(2, '0'); // ì´ˆë„ ì¶”ê°€í•˜ì—¬ ë” ì •í™•í•œ ì‹œê°„ í‘œì‹œ
        let ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12; // ì‹œê°„ì´ 0ì´ë©´ 12ë¡œ ë³€í™˜
        let currentTime = `${month}.${day}(${weekday}) ${hours}:${minutes}`;

        document.getElementById('current-time').textContent = currentTime;
        requestAnimationFrame(updateCurrentTime); // ë‹¤ìŒ í”„ë ˆì„ì— ì´ í•¨ìˆ˜ë¥¼ ë‹¤ì‹œ í˜¸ì¶œ
    }

    document.addEventListener('DOMContentLoaded', function() {
        requestAnimationFrame(updateCurrentTime); // í˜ì´ì§€ ë¡œë“œ í›„ ì²˜ìŒìœ¼ë¡œ í•¨ìˆ˜ í˜¸ì¶œ
    });

</script>

<script>
    function getWeatherIcon(sky, precipitation) {
        const icons = {
            clear: 'â˜€ï¸', // ë§‘ìŒ ì•„ì´ì½˜
            cloudy: 'ğŸŒ¥', // êµ¬ë¦„ë§ìŒ ì•„ì´ì½˜
            overcast: 'â˜ï¸', // íë¦¼ ì•„ì´ì½˜
            rain: 'ğŸŒ§', // ë¹„ ì•„ì´ì½˜
            sleet: 'ğŸŒ¨', // ë¹„/ëˆˆ ì•„ì´ì½˜
            snow: 'â„ï¸', // ëˆˆ ì•„ì´ì½˜
            shower: 'â›ˆ' // ì†Œë‚˜ê¸° ì•„ì´ì½˜
        };

        // í•˜ëŠ˜ ìƒíƒœë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì•„ì´ì½˜ ì„¤ì •
        let icon = '';
        switch(sky) {
            case 1: // ë§‘ìŒ
                icon = icons.clear;
                break;
            case 3: // êµ¬ë¦„ë§ìŒ
                icon = icons.cloudy;
                break;
            case 4: // íë¦¼
                icon = icons.overcast;
                break;
            default:
                icon = '';
        }

        // ê°•ìˆ˜ í˜•íƒœì— ë”°ë¼ ì•„ì´ì½˜ì„ ì¶”ê°€
        switch(precipitation) {
            case 1: // ë¹„
                icon = icons.rain;
                break;
            case 2: // ë¹„/ëˆˆ
                icon = icons.sleet;
                break;
            case 3: // ëˆˆ
                icon = icons.snow;
                break;
            case 4: // ì†Œë‚˜ê¸°
                icon = icons.shower;
                break;
            default:
        }

        return icon;
    }

</script>

</html>
