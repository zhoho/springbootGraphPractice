<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            text-align: center; /* 내용 중앙 정렬 */
            margin-top: 20px;
        }
        .btn-group .btn {
            padding: 0.375rem 0.75rem; /* 버튼의 패딩 */
            font-size: 0.875rem; /* 버튼의 폰트 크기를 줄임 */
        }
        .btn-group {
            justify-content: flex-end; /* 버튼 그룹을 오른쪽으로 정렬 */
            width: 700px;
            margin: auto;
            margin-bottom: 20px;
        }
        #mixedChart {
            width: 1000px; /* 그래프의 너비 */
            height: 700px; /* 그래프의 높이*/
            margin: auto; /* 중앙 정렬 */
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>

<div class="container">
    <h1 class="mt-5">연령별 및 성별 그래프</h1> <!-- 제목 -->

    <div id="weather">
        <p id="weather-data">로딩 중…</p>
    </div>

    <div class="btn-group mt-3"> <!-- 버튼 그룹 -->
        <input type="radio" class="btn-check" name="btnradio" id="btnradio1" autocomplete="off" checked>
        <label class="btn btn-outline-primary" for="btnradio1">여성</label>

        <input type="radio" class="btn-check" name="btnradio" id="btnradio2" autocomplete="off">
        <label class="btn btn-outline-primary" for="btnradio2">남성</label>
    </div>

    <div>
        <canvas id="mixedChart"></canvas> <!-- 그래프 캔버스 -->
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script th:inline="javascript">
    const ageDistribution = [[${ageDistribution}]]; // 연령 분포 데이터
    const femalesByAgeGroup = [[${femalesByAgeGroup}]]; // 연령대별 여성 수 데이터
    const totalPeople = Object.values(ageDistribution).reduce((a, b) => a + b, 0); // 총 인원 계산
    const femaleCount = Object.values(femalesByAgeGroup).reduce((a, b) => a + b, 0); // 전체 여성 수 계산
    const otherCount = totalPeople - femaleCount; // '기타' 성별 인원 계산

    const mixedCtx = document.getElementById('mixedChart'); // 혼합 차트를 위한 캔버스 요소 선택

    let mixedChart = new Chart(mixedCtx, {
        data: {
            datasets: [{
                type: 'bar',
                label: '연령 분포',
                data: Object.values(ageDistribution),
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.5)'
            }, {
                type: 'line',
                label: '성별 분포 (여성)',
                data: Object.values(femalesByAgeGroup),
                borderColor: 'rgb(255, 99, 132)',
                fill: false
            }],
            labels: Object.keys(ageDistribution) // X축 레이블을 연령대별로 설정
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        // Y축의 눈금을 정수로 설정
                        stepSize: 1,
                        // 눈금 값을 정수로 표시
                        callback: function(value) {
                            if (value % 1 === 0) {
                                return value;
                            }
                        }
                    }
                }
            }
        }
    });
    /*]]>*/
</script>

<script>
    $(document).ready(function() {
        // 남성 버튼 클릭 이벤트
        $('#btnradio2').click(function() {
            $.ajax({
                url: '/index/male/age-distribution',
                type: 'GET',
                success: function(data) {
                    mixedChart.data.datasets[1].data = Object.values(data); // 연령대별 남성 수 데이터로 업데이트
                    mixedChart.data.datasets[1].label = '성별 분포 (남성)';
                    mixedChart.update(); // 차트 업데이트
                },
                error: function(error) {
                    console.log(error);
                }
            });
        });

        // 여성 버튼 클릭 이벤트
        $('#btnradio1').click(function() {
            // 초기에 설정된 여성 데이터를 사용하여 차트 업데이트
            mixedChart.data.datasets[1].data = Object.values(femalesByAgeGroup);
            mixedChart.data.datasets[1].label = '성별 분포 (여성)';
            mixedChart.update(); // 차트 업데이트
        });
    });
</script>

<!--<script>-->
<!--    $(document).ready(function() {-->
<!--        var apiKey = 'cb8af9f3317bb3f9118d23f3cae2dd15';-->
<!--        var url = 'https://api.openweathermap.org/data/2.5/weather?q=Pohang&appid=' + apiKey + '&units=metric&lang=kr';-->

<!--        $.get(url, function(data) {-->
<!--            var temperature = data.main.temp;-->
<!--            var weatherDescription = data.weather[0].description;-->
<!--            var iconCode = data.weather[0].icon;-->
<!--            var iconUrl = "http://openweathermap.org/img/w/" + iconCode + ".png"; // 아이콘 이미지 URL 생성-->

<!--            $('#weather-data').html('포항의 기온: ' + temperature + '°C, ' + '상태: ' + weatherDescription + '<img src="' + iconUrl + '">'); // 아이콘 이미지 추가-->
<!--        }).fail(function() {-->
<!--            $('#weather-data').html('날씨 정보를 불러올 수 없습니다.');-->
<!--        });-->
<!--    });-->

<!--</script>-->

<script>
    $(document).ready(function() {
        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude;
                var lon = position.coords.longitude;
                var apiKey = 'cb8af9f3317bb3f9118d23f3cae2dd15';
                var url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=kr`;

                $.get(url, function(data) {
                    var temperature = data.main.temp;
                    var weatherDescription = data.weather[0].description;
                    var iconCode = data.weather[0].icon;
                    var iconUrl = "https://openweathermap.org/img/w/" + iconCode + ".png";
                    $('#weather-data').html('기온: ' + temperature + '°C, ' + '상태: ' + weatherDescription + '<img src="' + iconUrl + '">');
                }).fail(function() {
                    $('#weather-data').html('날씨 정보를 불러올 수 없습니다.');
                });
            }, function() {
                $('#weather-data').html('위치 정보를 가져올 수 없습니다.');
            });
        } else {
            $('#weather-data').html('Geolocation을 지원하지 않는 브라우저입니다.');
        }
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
</body>
</html>
