<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Graph Practice</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <link th:href="@{/css/style.css}" rel="stylesheet" />
    <script th:src="@{/js/getweather.js}"></script>
    <style>
        .button {
            width: 100%; /* ë²„íŠ¼ì˜ ë„ˆë¹„ë¥¼ ì»¨í…Œì´ë„ˆì— ë§ì¶¥ë‹ˆë‹¤. */
            margin-bottom: 10px !important; /* ë²„íŠ¼ ì‚¬ì´ì˜ ìˆ˜ì§ ê°„ê²©ì„ ì¤„ì…ë‹ˆë‹¤. */
            padding: 20px 10px !important;
        }

        /* ì‚¬ìš©ì ì§€ì • ë²„íŠ¼ ìƒ‰ìƒ */
        .btn-custom {
            background-color: #F7F8E0;
            border-color: #F7F8E0;
        }

        .btn-custom:hover {
            background-color: #F2F5A9;
        }


        /* ê° rowì— ëŒ€í•œ ê°„ê²©ì„ ì¡°ì •í•©ë‹ˆë‹¤. */
        .row {
            margin-right: -15px; /* ë¶€íŠ¸ìŠ¤íŠ¸ë© rowì˜ ìŒìˆ˜ ë§ˆì§„ì„ ì¬ì¡°ì •í•©ë‹ˆë‹¤. */
            margin-left: -15px; /* ë¶€íŠ¸ìŠ¤íŠ¸ë© rowì˜ ìŒìˆ˜ ë§ˆì§„ì„ ì¬ì¡°ì •í•©ë‹ˆë‹¤. */
        }

        /* ê° ì»¬ëŸ¼ì˜ íŒ¨ë”©ì„ ì¡°ì •í•˜ì—¬ ê°„ê²©ì„ ë™ì¼í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤. */
        .row, .row > [class*='col-'] {
            padding-right: 5px; /* ì»¬ëŸ¼ ì˜¤ë¥¸ìª½ íŒ¨ë”©ì„ ì¤„ì…ë‹ˆë‹¤. */
            padding-left: 5px; /* ì»¬ëŸ¼ ì™¼ìª½ íŒ¨ë”©ì„ ì¤„ì…ë‹ˆë‹¤. */
        }

        /* ë¶€íŠ¸ìŠ¤íŠ¸ë© ê·¸ë¦¬ë“œ ê°„ê²©ì„ ì¡°ì •í•  ìˆ˜ ìˆëŠ” í´ë˜ìŠ¤ ì¶”ê°€ */
        .gap {
            gap: 15px; /* grid-gap ì†ì„±ìœ¼ë¡œ ì—´ ì‚¬ì´ì˜ ê°„ê²©ì„ ì¡°ì •í•©ë‹ˆë‹¤. */
        }


    </style>
</head>

<body>

<div class="container">
<!-- ë‹¨ê³„ë³„ ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ, ì´ˆê¸°ì—ëŠ” step1ë§Œ í‘œì‹œ -->
    <div id="step1-container" class="step-container">
        <div id="step1-list" class="row"> <!-- ë³€ê²½ëœ ë¶€ë¶„: ulì´ ì•„ë‹Œ divë¡œ ìˆ˜ì • -->
        </div>
    </div>

    <div id="step2-container" class="step-container" style="display:none;">
        <button onclick="goBackToStep1()" class="btn btn-secondary mb-3">&lt;</button>
        <div id="step2-list" class="row">
        </div>
    </div>

    <div id="step3-container" class="step-container" style="display:none;">
        <button onclick="goBackToStep2()" class="btn btn-secondary mb-3">&lt;</button>
        <div id="step3-list" class="row">
        </div>
    </div>

</div>

<div id="weather-data"></div>

<p id="coordinates-display"></p>


<script> // 3ì„ íƒ

function goBackToStep1() {
    document.getElementById('step1-container').style.display = 'block';
    document.getElementById('step2-container').style.display = 'none';
    document.getElementById('step3-container').style.display = 'none';
}

function goBackToStep2() {
    document.getElementById('step2-container').style.display = 'block';
    document.getElementById('step3-container').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    fetchCities();
});

function fetchCities() {
    fetch('/api/cities')
        .then(response => response.json())
        .then(citiesData => {
            const step1List = document.getElementById('step1-list');
            step1List.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ì„ ì§€ì›ë‹ˆë‹¤.
            citiesData.forEach((city) => {
                const colDiv = document.createElement('div');
                // ë¶€íŠ¸ìŠ¤íŠ¸ë©ì—ì„œ 3ì—´ë¡œ ì •ë ¬í•˜ê¸° ìœ„í•´ col-lg-4ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                colDiv.className = 'col-lg-4 d-flex justify-content-center align-items-stretch';
                const button = document.createElement('button');
                button.textContent = city;
                button.className = 'btn btn-custom button my-2 button my-2'; // ë¶€íŠ¸ìŠ¤íŠ¸ë© ë²„íŠ¼ í´ë˜ìŠ¤ ì‚¬ìš©
                button.onclick = function() { onStep1Clicked(city); };
                colDiv.appendChild(button);
                step1List.appendChild(colDiv);
            });
        })
        .catch(error => console.error('Error fetching cities:', error));
}


function onStep1Clicked(cityValue) {
    fetch(`/api/districts/${encodeURIComponent(cityValue)}`)
        .then(response => response.json())
        .then(districtsData => {
            const step2List = document.getElementById('step2-list');
            step2List.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ì„ ì§€ì›ë‹ˆë‹¤.
            districtsData.forEach((district) => {
                if (district.trim() !== '') { // ê°’ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ë²„íŠ¼ ìƒì„±
                    const colDiv = document.createElement('div');
                    colDiv.className = 'col-lg-4 d-flex justify-content-center align-items-stretch mb-3';
                    const button = document.createElement('button');
                    button.textContent = district;
                    button.className = 'btn btn-custom button my-2 button my-2'; // ë¶€íŠ¸ìŠ¤íŠ¸ë© ë²„íŠ¼ í´ë˜ìŠ¤ ì‚¬ìš©
                    button.onclick = function() { onStep2Clicked(cityValue, district); };
                    colDiv.appendChild(button);
                    step2List.appendChild(colDiv);
                }
            });
            document.getElementById('step2-container').style.display = 'block';
            document.getElementById('step1-container').style.display = 'none';
        })
        .catch(error => console.error('Error fetching districts:', error));
}

function onStep2Clicked(cityValue, districtValue) {
    fetch(`/api/subdistricts/${encodeURIComponent(cityValue)}/${encodeURIComponent(districtValue)}`)
        .then(response => response.json())
        .then(subdistrictsData => {
            const step3List = document.getElementById('step3-list');
            step3List.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ì„ ì§€ì›ë‹ˆë‹¤.
            subdistrictsData.forEach((subdistrict) => {
                if (subdistrict.trim() !== '') { // ê°’ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ë²„íŠ¼ ìƒì„±
                    const colDiv = document.createElement('div');
                    colDiv.className = 'col-lg-4 d-flex justify-content-center align-items-stretch mb-3';
                    const button = document.createElement('button');
                    button.textContent = subdistrict;
                    button.className = 'btn btn-custom button my-2 button my-2'; // ë¶€íŠ¸ìŠ¤íŠ¸ë© ë²„íŠ¼ í´ë˜ìŠ¤ ì‚¬ìš©
                    button.onclick = function() { onStep3Clicked(cityValue, districtValue, subdistrict); };
                    colDiv.appendChild(button);
                    step3List.appendChild(colDiv);
                }
            });
            document.getElementById('step3-container').style.display = 'block'; // step3 ì»¨í…Œì´ë„ˆë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
            document.getElementById('step2-container').style.display = 'none'; // step2 ì»¨í…Œì´ë„ˆë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
        })
        .catch(error => console.error('Error fetching subdistricts:', error));
}


function onStep3Clicked(city, district, subdistrict) {
    fetch(`/api/coordinates?city=${encodeURIComponent(city)}&district=${encodeURIComponent(district)}&subdistrict=${encodeURIComponent(subdistrict)}`)
        .then(response => response.json())
        .then(location => {
            if(location) {
                console.log('Coordinates:', location);
                // ì¢Œí‘œ ì •ë³´ë¥¼ DOMì— í‘œì‹œí•˜ê±°ë‚˜ ë‹¤ë¥¸ ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                // ì˜ˆë¥¼ ë“¤ì–´, ì•„ë˜ ì½”ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ HTML ìš”ì†Œì— ì¢Œí‘œë¥¼ í‘œì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                document.getElementById('coordinates-display').textContent = `X: ${location.X}, Y: ${location.Y}`;
                getWeather(location.X, location.Y);
            } else {
                console.error('Location not found');
            }
        })
        .catch(error => console.error('Error:', error));
}
</script>

<script>
    function getNextForecastTime() {
        let now = new Date();
        let nextForecastHour = Math.floor(now.getHours() / 3) * 3 - 1;
        if(nextForecastHour.toString().padStart(2, '0') === '00' || nextForecastHour.toString().padStart(2, '0') === '01' || nextForecastHour.toString().padStart(2, '0') === '02') {
            return '2300';
        }
        if(Math.floor(now.getHours())% 3 === 2 && now.getMinutes() >= 11) {
            return Math.floor(now.getHours()).toString().padStart(2, '0') + '00';
        }
        console.log(nextForecastHour.toString().padStart(2, '0') + '10');
        return nextForecastHour.toString().padStart(2, '0') + '00'; // ì˜ˆ: '0210', '0510'
    }

    function getWeather(gridX, gridY) {
        console.log("Fetching weather for coordinates:", gridX, gridY); // Debugging log
        var forecastTime = getNextForecastTime(); // ë‹¤ìŒ ì˜ˆë³´ ì‹œê°„ ê³„ì‚°
        var currentDate = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        console.log(forecastTime);
        console.log(currentDate);
        var xhr = new XMLHttpRequest();
        var url = 'https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst';
        var queryParams = '?' + encodeURIComponent('serviceKey') + '=' + 'hogAXADhx1TwUFYu9kBfwwvsv5m%2FwsLzvQT2tBT0BFSH3eLnXp88Dx%2FR6x2GCPtWKfaUQEPix2VcWYEp0Hz5Tw%3D%3D';
        queryParams += '&' + encodeURIComponent('pageNo') + '=' + encodeURIComponent('1');
        queryParams += '&' + encodeURIComponent('numOfRows') + '=' + encodeURIComponent('37'); //12ê°œì”© ì ìš© 12*4 = 48
        queryParams += '&' + encodeURIComponent('dataType') + '=' + encodeURIComponent('XML');
        queryParams += '&' + encodeURIComponent('base_date') + '=' + encodeURIComponent(currentDate);
        queryParams += '&' + encodeURIComponent('base_time') + '=' + encodeURIComponent(forecastTime);


        queryParams += '&' + encodeURIComponent('nx') + '=' + encodeURIComponent(gridX);
        queryParams += '&' + encodeURIComponent('ny') + '=' + encodeURIComponent(gridY);
        xhr.open('GET', url + queryParams);
        xhr.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200) {
                // ë‚ ì”¨ ë°ì´í„° ì²˜ë¦¬
                displayWeatherData(this.responseXML);
                // console.log(this.responseText);
            }
        };
        xhr.send();
    }

    function calculateCurrentTime() {
        let now = new Date();
        let currentTime = Math.floor(now.getHours()) * 100 - getNextForecastTime() - 100;
        return currentTime / 100;
    }
    function displayWeatherData(xml) {
        const items = xml.getElementsByTagName("item");
        let weatherData = {};
        let startPoint = calculateCurrentTime();
        console.log(startPoint * 12);
        // ë°ì´í„° êµ¬ì¡°í™”
        console.log("ì•„ì´í…œ length : " + items.length);
        for (let i = startPoint * 12; i < (items.length /3 - 1) * (startPoint + 1); i++) {
            const category = items[i].getElementsByTagName("category")[0].childNodes[0].nodeValue;
            const value = items[i].getElementsByTagName("fcstValue")[0].childNodes[0].nodeValue;
            const time = items[i].getElementsByTagName("fcstTime")[0].childNodes[0].nodeValue;

            if (!weatherData[time]) {
                weatherData[time] = {};
            }
            weatherData[time][category] = value;
        }

        // í…Œì´ë¸” ìƒì„±
        let output = "<h3>Weather Forecast</h3>";
        output += "<table class='table table-striped table-hover'><thead class='table-dark'><tr><th>Time</th><th>Temperature (Â°C)</th><th>Wind Speed (m/s)</th><th>Humidity (%)</th><th>Precipitation</th><th>Sky Condition</th><th>Weather Icon</th></tr></thead><tbody>";

        for (const [time, data] of Object.entries(weatherData)) {
            const weatherIcon = getWeatherIcon(parseInt(data['SKY']), parseInt(data['PTY']));
            output += `<tr>
                <td>${time}</td>
                <td>${data['TMP'] || 'â€”'}</td>
                <td>${data['WSD'] || 'â€”'}</td>
                <td>${data['REH'] || 'â€”'}</td>
                <td>${data['PCP'] || 'â€”'}</td>
                <td>${data['SKY'] || 'â€”'}</td>
                <td>${weatherIcon || 'â€”'}</td>
              </tr>`;
        }

        output += "</tbody></table>";
        document.getElementById("weather-data").innerHTML = output;
    }


    $(document).ready(function() {
        setupAutocomplete('#city', 'city', 'cityResults');
        setupAutocomplete('#district', 'district', 'districtResults');
        setupAutocomplete('#subdistrict', 'subdistrict', 'subdistrictResults');

        function setupAutocomplete(selector, type, resultListId) {
            $(selector).on('input', function() {
                var input = $(this).val();
                if (input.length > 1) {
                    $.ajax({
                        url: '/searchAddress',
                        method: 'GET',
                        data: { type: type, searchTerm: input },
                        success: function(data) {
                            var autocompleteResults = $('#' + resultListId);
                            autocompleteResults.empty();
                            data.forEach(function(item) {
                                autocompleteResults.append($('<option>').val(item));
                            });
                        }
                    });
                }
            });
        }
    });

    document.addEventListener("DOMContentLoaded", function() {
        var gridX = document.getElementById('gridX').value;
        var gridY = document.getElementById('gridY').value;
        if (gridX && gridY) {
            getWeather(gridX, gridY);
        }
    });

</script>

<script>
    function getWeatherIcon(sky, precipitation) {
        const icons = {
            clear: 'â˜€ï¸', // ë§‘ìŒ ì•„ì´ì½˜
            cloudy: 'ğŸŒ¥', // êµ¬ë¦„ë§ìŒ ì•„ì´ì½˜
            overcast: 'â˜ï¸', // íë¦¼ ì•„ì´ì½˜
            rain: 'ğŸŒ§', // ë¹„ ì•„ì´ì½˜
            sleet: 'ğŸŒ¨', // ë¹„/ëˆˆ ì•„ì´ì½˜
            snow: 'â„ï¸', // ëˆˆ ì•„ì´ì½˜
            shower: 'â›ˆ' // ì†Œë‚˜ê¸° ì•„ì´ì½˜
        };

        // í•˜ëŠ˜ ìƒíƒœë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì•„ì´ì½˜ ì„¤ì •
        let icon = '';
        switch(sky) {
            case 1: // ë§‘ìŒ
                icon = icons.clear;
                break;
            case 3: // êµ¬ë¦„ë§ìŒ
                icon = icons.cloudy;
                break;
            case 4: // íë¦¼
                icon = icons.overcast;
                break;
            default:
                icon = '';
        }

        // ê°•ìˆ˜ í˜•íƒœì— ë”°ë¼ ì•„ì´ì½˜ì„ ì¶”ê°€
        switch(precipitation) {
            case 1: // ë¹„
                icon = icons.rain;
                break;
            case 2: // ë¹„/ëˆˆ
                icon = icons.sleet;
                break;
            case 3: // ëˆˆ
                icon = icons.snow;
                break;
            case 4: // ì†Œë‚˜ê¸°
                icon = icons.shower;
                break;
            default:
        }

        return icon;
    }

</script>

</body>
</html>
